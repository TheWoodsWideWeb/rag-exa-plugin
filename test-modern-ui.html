<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern UI Test</title>
    <style>
        body {
            background: #0C0012;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-button {
            background: #3bb273;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        
        .test-button:hover {
            background: #2d8f5a;
        }
        
        .test-results {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß† Modern UI Test</h1>
        <p>Testing the new modern UI functions without external dependencies.</p>
        
        <button class="test-button" onclick="testCreateModernAnswerBlock()">Test Answer Block Creation</button>
        <button class="test-button" onclick="testCreateModernSourceCards()">Test Source Cards</button>
        <button class="test-button" onclick="testSourcesTab()">Test Sources Tab</button>
        <button class="test-button" onclick="testTabSwitching()">Test Tab Switching</button>
        
        <div id="test-results" class="test-results">
            <h3>Test Results</h3>
            <p>Click the buttons above to test the modern UI functionality.</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Mock data for testing
        const mockResults = [
            {
                url: 'https://wikipedia.org',
                title: 'Wikipedia - Test Source',
                favicon: 'https://www.google.com/s2/favicons?sz=64&domain=wikipedia.org'
            },
            {
                url: 'https://example.com',
                title: 'Example - Another Test Source',
                favicon: 'https://www.google.com/s2/favicons?sz=64&domain=example.com'
            }
        ];

        // Test function for creating modern answer block
        function testCreateModernAnswerBlock() {
            try {
                const questionID = 'test-' + Date.now();
                const query = 'Test question about psychedelics';
                const block = createModernAnswerBlock(questionID, query, mockResults);
                
                $('#test-results').html(`
                    <h3>‚úÖ Answer Block Created Successfully</h3>
                    <p>Question ID: ${questionID}</p>
                    <p>Query: ${query}</p>
                    <p>Results count: ${mockResults.length}</p>
                    <div id="test-block"></div>
                `);
                
                $('#test-block').append(block);
                
                // Test tab switching
                setTimeout(() => {
                    testTabSwitching();
                }, 1000);
                
            } catch (error) {
                $('#test-results').html(`
                    <h3>‚ùå Error Creating Answer Block</h3>
                    <p>Error: ${error.message}</p>
                    <pre>${error.stack}</pre>
                `);
            }
        }

        // Test function for creating source cards
        function testCreateModernSourceCards() {
            try {
                const testBlock = $('<div class="test-block"></div>');
                createModernSourceCards(testBlock, mockResults);
                
                $('#test-results').html(`
                    <h3>‚úÖ Source Cards Created Successfully</h3>
                    <p>Results count: ${mockResults.length}</p>
                    <div id="test-source-cards"></div>
                `);
                
                $('#test-source-cards').append(testBlock);
                
            } catch (error) {
                $('#test-results').html(`
                    <h3>‚ùå Error Creating Source Cards</h3>
                    <p>Error: ${error.message}</p>
                    <pre>${error.stack}</pre>
                `);
            }
        }

        // Test function for Sources tab
        function testSourcesTab() {
            try {
                const testBlock = $('<div class="test-block"></div>');
                populateSourcesTab(testBlock, mockResults);
                
                $('#test-results').html(`
                    <h3>‚úÖ Sources Tab Populated Successfully</h3>
                    <p>Results count: ${mockResults.length}</p>
                    <div id="test-sources-tab"></div>
                `);
                
                $('#test-sources-tab').append(testBlock);
                
            } catch (error) {
                $('#test-results').html(`
                    <h3>‚ùå Error Populating Sources Tab</h3>
                    <p>Error: ${error.message}</p>
                    <pre>${error.stack}</pre>
                `);
            }
        }

        // Test function for tab switching
        function testTabSwitching() {
            try {
                const tabBtns = $('.tab-btn');
                if (tabBtns.length > 0) {
                    // Test clicking on different tabs
                    tabBtns.each((index, btn) => {
                        setTimeout(() => {
                            $(btn).click();
                        }, index * 500);
                    });
                    
                    $('#test-results').append(`
                        <p>‚úÖ Tab switching tested successfully</p>
                    `);
                } else {
                    $('#test-results').append(`
                        <p>‚ö†Ô∏è No tabs found to test</p>
                    `);
                }
            } catch (error) {
                $('#test-results').append(`
                    <p>‚ùå Error testing tab switching: ${error.message}</p>
                `);
            }
        }

        // Modern UI Functions (copied from exa.js)
        function createModernAnswerBlock(questionID, query, results = []) {
            return $(`<div class="answer-block modern-ui" id="${questionID}">
                <div class="answer-header">
                    <h1 class="exa-user-question">${query}</h1>
                    <div class="answer-tabs">
                        <button class="tab-btn active" data-tab="answer">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 1v6m0 6v6"></path>
                            </svg>
                            Answer
                        </button>
                        <button class="tab-btn" data-tab="images">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21,15 16,10 5,21"></polyline>
                            </svg>
                            Images
                        </button>
                        <button class="tab-btn" data-tab="sources">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
                            </svg>
                            Sources ${results ? results.length : 0}
                        </button>

                    </div>
                </div>
                <div class="tab-content active" data-tab="answer">
                    <div class="exa-results"></div>
                    <div class="exa-answer-streaming space-owl-m">This is a test answer content.</div>
                </div>
                <div class="tab-content" data-tab="images">
                    <div class="images-placeholder">Images will appear here</div>
                </div>
                <div class="tab-content" data-tab="sources">
                    <div class="sources-content"></div>
                </div>

            </div>`);
        }

        function createModernSourceCards(block, results) {
            if (!results || !Array.isArray(results) || results.length === 0) {
                block.find('.exa-results').html(`
                    <div class="sources-header">
                        <span>üìö No sources found</span>
                    </div>
                `);
                return;
            }
            
            const cards = results.map(item => {
                let domain = 'unknown';
                try {
                    if (item.url) {
                        domain = new URL(item.url).hostname.replace('www.', '');
                    }
                } catch (e) {
                    console.warn('Invalid URL:', item.url);
                }
                const isBadFavicon = !item.favicon || item.favicon === "data:," || item.favicon === "about:blank";
                
                const fallbackIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iNCIgZmlsbD0iIzY2NjY2NiIvPgo8L3N2Zz4K';
                const image = `<img src="${item.favicon || fallbackIcon}" alt="favicon" class="exa-favicon" onerror="this.src='${fallbackIcon}'">`;
                
                return `<div class="source-card">
                    <div class="source-card-header">${image}<span class="exa-domain">${domain}</span></div>
                    <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="source-title">${item.title}</a>
                </div>`;
            }).join('');

            const sourceCount = results.length;
            const displayCount = sourceCount; // Show all sources, no cap
            block.find('.exa-results').html(`
                <div class="sources-header">
                    <span>üìö ${displayCount} source${displayCount !== 1 ? 's' : ''} found</span>
                </div>
                <div class="sources-container">
                    <button class="slider-btn prev-btn">&#10094;</button>
                    <div class="top-sources-wrapper">${cards}</div>
                    <button class="slider-btn next-btn">&#10095;</button>
                </div>
            `);
        }

        // Populate Sources tab with detailed source information
        function populateSourcesTab(block, results) {
            if (!results || !Array.isArray(results) || results.length === 0) {
                block.find('.sources-content').html(`
                    <div class="sources-empty-state">
                        <div class="empty-icon">üìö</div>
                        <h3>No Sources Found</h3>
                        <p>No sources were found for this query.</p>
                    </div>
                `);
                return;
            }

            const sourcesHtml = results.map((item, index) => {
                let domain = 'unknown';
                try {
                    if (item.url) {
                        domain = new URL(item.url).hostname.replace('www.', '');
                    }
                } catch (e) {
                    console.warn('Invalid URL:', item.url);
                }

                const fallbackIcon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iNCIgZmlsbD0iIzY2NjY2NiIvPgo8L3N2Zz4K';
                const faviconUrl = item.favicon || fallbackIcon;

                return `
                    <div class="source-item" data-index="${index}">
                        <div class="source-item-header">
                            <div class="source-favicon">
                                <img src="${faviconUrl}" alt="favicon" onerror="this.src='${fallbackIcon}'">
                            </div>
                            <div class="source-info">
                                <div class="source-domain">${domain}</div>
                                <div class="source-title">${item.title || 'Untitled'}</div>
                            </div>
                            <div class="source-actions">
                                <button class="source-action-btn" onclick="window.open('${item.url}', '_blank')" title="Open Source">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15,3 21,3 21,9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </button>
                                <button class="source-action-btn" onclick="copyToClipboard('${item.url}')" title="Copy URL">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="source-item-details">
                            <div class="source-url">
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.url}</a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const sourcesHeader = `
                <div class="sources-tab-header">
                    <div class="sources-count">
                        <span class="count-number">${results.length}</span>
                        <span class="count-label">Sources Found</span>
                    </div>
                    <div class="sources-filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="recent">Recent</button>
                        <button class="filter-btn" data-filter="relevance">Relevance</button>
                    </div>
                </div>
            `;

            block.find('.sources-content').html(sourcesHeader + sourcesHtml);
        }

        // Copy URL to clipboard function
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('URL copied to clipboard!');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('URL copied to clipboard!');
            }
        }

        // Tab switching functionality
        $(document).on('click', '.tab-btn', function(e) {
            e.preventDefault();
            const tabName = $(this).data('tab');
            const answerBlock = $(this).closest('.answer-block');
            
            // Update active tab button
            answerBlock.find('.tab-btn').removeClass('active');
            $(this).addClass('active');
            
            // Update active tab content
            answerBlock.find('.tab-content').removeClass('active');
            answerBlock.find(`[data-tab="${tabName}"]`).addClass('active');
        });

        // Add basic styling for the test
        $('<style>')
            .prop('type', 'text/css')
            .html(`
                .modern-ui {
                    background: #0C0012;
                    border-radius: 16px;
                    padding: 24px;
                    margin-bottom: 24px;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .modern-ui .answer-header {
                    margin-bottom: 24px;
                }
                
                .modern-ui .exa-user-question {
                    font-size: 28px;
                    font-weight: 700;
                    color: #fff;
                    margin: 0 0 20px 0;
                    line-height: 1.2;
                }
                
                .modern-ui .answer-tabs {
                    display: flex;
                    gap: 8px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    padding-bottom: 16px;
                }
                
                .modern-ui .tab-btn {
                    background: transparent;
                    border: none;
                    color: rgba(255, 255, 255, 0.7);
                    padding: 12px 16px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.2s ease;
                    position: relative;
                }
                
                .modern-ui .tab-btn:hover {
                    color: #fff;
                    background: rgba(255, 255, 255, 0.05);
                }
                
                .modern-ui .tab-btn.active {
                    color: #fff;
                    background: rgba(255, 255, 255, 0.1);
                }
                
                .modern-ui .tab-btn.active::after {
                    content: '';
                    position: absolute;
                    bottom: -17px;
                    left: 0;
                    right: 0;
                    height: 2px;
                    background: #fff;
                    border-radius: 1px;
                }
                
                .modern-ui .tab-btn svg {
                    width: 16px;
                    height: 16px;
                    stroke: currentColor;
                    fill: none;
                }
                
                .modern-ui .tab-content {
                    display: none;
                    padding: 20px 0;
                }
                
                .modern-ui .tab-content.active {
                    display: block;
                }
                
                .modern-ui .images-placeholder,
                .modern-ui .sources-placeholder,
                .modern-ui .steps-placeholder {
                    text-align: center;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 16px;
                    padding: 40px 20px;
                    background: rgba(255, 255, 255, 0.02);
                    border-radius: 12px;
                    border: 1px dashed rgba(255, 255, 255, 0.1);
                }
                
                .modern-ui .sources-header {
                    margin-bottom: 20px;
                    text-align: center;
                    color: #fff;
                    font-size: 14px;
                    font-weight: 500;
                }
                
                .modern-ui .sources-container {
                    position: relative;
                    margin: 0 -12px;
                }
                
                .modern-ui .top-sources-wrapper {
                    display: flex;
                    gap: 16px;
                    overflow-x: auto;
                    scroll-behavior: smooth;
                    padding: 0 12px;
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                }
                
                .modern-ui .top-sources-wrapper::-webkit-scrollbar {
                    display: none;
                }
                
                .modern-ui .source-card {
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 12px;
                    padding: 16px;
                    min-width: 200px;
                    flex-shrink: 0;
                    transition: all 0.2s ease;
                }
                
                .modern-ui .source-card:hover {
                    background: rgba(255, 255, 255, 0.08);
                    border-color: rgba(255, 255, 255, 0.2);
                    transform: translateY(-2px);
                }
                
                .modern-ui .source-card-header {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 12px;
                }
                
                .modern-ui .exa-favicon {
                    width: 20px;
                    height: 20px;
                    border-radius: 4px;
                }
                
                .modern-ui .exa-domain {
                    color: rgba(255, 255, 255, 0.7);
                    font-size: 12px;
                    font-weight: 500;
                }
                
                .modern-ui .source-title {
                    color: #fff;
                    text-decoration: none;
                    font-size: 14px;
                    line-height: 1.4;
                    display: -webkit-box;
                    -webkit-line-clamp: 3;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                    transition: color 0.2s ease;
                }
                
                .modern-ui .source-title:hover {
                    color: #3bb273;
                }
                
                .modern-ui .slider-btn {
                    position: absolute;
                    top: 50%;
                    transform: translateY(-50%);
                    background: rgba(0, 0, 0, 0.8);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    color: #fff;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                    transition: all 0.2s ease;
                    z-index: 10;
                }
                
                .modern-ui .slider-btn:hover {
                    background: rgba(0, 0, 0, 0.9);
                    border-color: rgba(255, 255, 255, 0.3);
                }
                
                .modern-ui .slider-btn.prev-btn {
                    left: 8px;
                }
                
                .modern-ui .slider-btn.next-btn {
                    right: 8px;
                }
            `)
            .appendTo('head');
    </script>
</body>
</html>
